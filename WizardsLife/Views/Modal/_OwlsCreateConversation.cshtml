@model WizardsLife.Models.Modals.Owls.CreateConversation_VM

<script>
    $(function() {
        var availableTags = @Html.Raw(Json.Encode(@Model.FriendNames));


        function split( val ) {
            return val.split( /,\s*/ );
        }
        function extractLast( term ) {
            return split( term ).pop();
        }

        $( "#recipient" )
        // don't navigate away from the field on tab when selecting an item
        .bind( "keydown", function( event ) {
            if ( event.keyCode === $.ui.keyCode.TAB &&
                $( this ).autocomplete( "instance" ).menu.active ) {
                event.preventDefault();
            }
        })
        .autocomplete({
            minLength: 0,
            source: function( request, response ) {
                // delegate back to autocomplete, but extract the last term
                response( $.ui.autocomplete.filter(
                availableTags, extractLast( request.term ) ) );
            },
            focus: function() {
                // prevent value inserted on focus
                return false;
            },
            select: function( event, ui ) {
                var terms = split( this.value );
                // remove the current input
                terms.pop();
                // add the selected item
                terms.push( ui.item.value );
                // add placeholder to get the comma-and-space at the end
                terms.push( "" );
                this.value = terms.join( ", " );
                return false;
            }
        });
    });
</script>

@{ 
    if (!string.IsNullOrWhiteSpace(Model.Error))
    {
        <p style="color:#F00;">@Model.Error</p>
    }
}

@using (Html.BeginForm("CreateConversation", "Modal", FormMethod.Post, new { type = "replace", replace = "#owlContent", responseType = "PartialView" }))
{
    <input type="hidden" name="FriendNames" value="@string.Join(",", Model.FriendNames)" />
    <table width="99%" cellpadding="0" cellspacing="0" style="line-height:30px;">
        <tr>
            <td style="width:150px;">Recipient:</td>
            <td>
                <input id="recipient" name="Recipient" type="text" value="@Model.Recipient" />
            </td>
        </tr>
        <tr>
            <td>Subject:</td>
            <td>
                <input name="Subject" type="text" value="@Model.Subject" />
            </td>
        </tr>
        <tr>
            <td colspan="2">Content</td>
        </tr>
        <tr>
            <td colspan="2">
                <textarea style="width:100%; height:100px; max-width:100%;" name="Content">@Model.Content</textarea>
            </td>
        </tr>
    </table>
    <input type="submit" value="Send owl" />
}
